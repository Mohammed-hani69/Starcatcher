<!DOCTYPE html>
<html dir="rtl" lang="ar">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="static/css/dashboard.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- ุฅุถุงูุฉ ููุชุจุฉ Chart.js ููุฑุณูู ุงูุจูุงููุฉ -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='image/STAR CATCHER FINAL LOGO-11.png') }}">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
        <meta name="csrf-token" content="{{ csrf_token }}">
    </head>
    <body>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/api/placeholder/45/45" alt="Logo">
                <span>ููุญุฉ ุงูุชุญูู</span>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ</div>
                <nav>
                    <a href="/dashboard" class="nav-item active">
                        <i>๐</i>
                        <span>ุงูุฑุฆูุณูุฉ</span>
                    </a>
                    <a href="/add_player" class="nav-item ">
                        <i>๐ฅ</i>
                        <span>ุงููุงุนุจูู</span>
                    </a>
                    <a href="/add_club" class="nav-item">
                        <i>โฝ</i>
                        <span>ุงูุฃูุฏูู</span>
                    </a>
                    <a href="/add_subscription" class="nav-item">
                        <i>๐</i>
                        <span>ุงูุจุงูุงุช</span>
                    </a>
                </nav>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ุงูุฅุฏุงุฑุฉ</div>
                <nav>
                    <a href="#" class="nav-item">
                        <i>๐</i>
                        <span>ุงูุฅุญุตุงุฆูุงุช</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i>โ๏ธ</i>
                        <span>ุงูุฅุนุฏุงุฏุงุช</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i>๐</i>
                        <span>ุงูุชูุงุฑูุฑ</span>
                    </a>
                </nav>
            </div>
            <!-- ุฅุถุงูุฉ ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุฃุณูู ุงูุดุฑูุท ุงูุฌุงูุจู -->
        <div class="logout-section">
            <a href="/logout" class="nav-item logout-btn">
                <i>๐ช</i>
                <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
            </a>
        </div>
        </aside>

        <!-- Header -->
        <header class="header">
            <h2 class="header-title">Catcher<span style="color:red">Star</span></h2>
            
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" placeholder="ุจุญุซ...">
                    <i>๐</i>
                </div>
                
                <div class="header-links">
                    <div class="header-icon">
                        <i>๐</i>
                        <span class="notification-badge">3</span>
                    </div>
                    <div class="header-icon">
                        <i>โ๏ธ</i>
                        <span class="notification-badge">5</span>
                    </div>
                </div>

                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name">{{username}}</div>
                        <div class="user-role">ูุฏูุฑ ุงููุธุงู</div>
                    </div>
                    <div class="user-avatar">{{username[:1]}}</div>
                </div>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">ุฅุฌูุงูู ุงููุงุนุจูู</div>
                    <div class="stat-value">{{count_player}}</div>
                    <div class="stat-change">+12% ูุฐุง ุงูุดูุฑ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุนูููุงุช ุงูุจูุน</div>
                    <div class="stat-value">845</div>
                    <div class="stat-change">+8% ูุฐุง ุงูุฃุณุจูุน</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุงูุจุทุงูุงุช ุงููุงุฏุฑุฉ</div>
                    <div class="stat-value">156</div>
                    <div class="stat-change">+5% ูุฐุง ุงูุดูุฑ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ุงููุณุชุฎุฏููู ุงููุดุทูู</div>
                    <div class="stat-value">2,567</div>
                    <div class="stat-change">+15% ูุฐุง ุงูุดูุฑ</div>
                </div>
            </div>
        
            <!-- Main Content Grid -->
            <div class="content-grid">
                <!-- Market Section -->
                <div class="market-section">
                    <div class="section-header">
                        <h3>ุณูู ุงููุงุนุจูู</h3>
                        <button class="action-button add_player">ุฅุถุงูุฉ ูุงุนุจ ููุณูู</button>
                    </div>
        
                    <!-- Player Cards -->
                    <div class="players-container">
                        {% for listings in listings %}
                        <div class="player-card {{ listings.rarity.lower() }}">
                            <div class="card-sheen"></div>
                            
                            <!-- Image Section (Right Side) -->
                            <div class="player-image-container">
                                {% if listings.player_image_url %}
                                    <img src="static/uploads/image_player/{{ listings.player_image_url }}" alt="{{ listings.player_name }}" class="player-image">
                                {% else %}
                                    <div class="player-avatar">{{ listings.player_name[:1] }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Content Section (Left Side) -->
                            <div class="content-container">
                                <!-- Rating Circle -->
                                <div class="rating-circle">
                                    <span class="rating-number">{{ listings.player_rating }}</span>
                                    <span class="position">{{ listings.player_position }}</span>
                                </div>
                                
                                <!-- Player Details -->
                                <div class="player-details">
                                    <div class="player-name">{{ listings.player_name }}</div>
                                    <div class="player-meta">
                                        <span class="status">{{ listings.status }}</span>
                                    </div>
                                    <div class="player-price">{{ listings.price }} coins</div>
                                    <div class="created-date">{{ listings.expires_at }}</div>
                                </div>
                            </div>
                            
                            <!-- Delete Button -->
                            <button class="delete-btn" data-id="{{ listings.id }}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            
                            <!-- Rarity Badge -->
                            <div class="rarity-indicator">
                                {% if listings.rarity.lower() == 'common' %}
                                    ุนุงุฏู
                                {% elif listings.rarity.lower() == 'rare' %}
                                    ูุงุฏุฑ
                                {% elif listings.rarity.lower() == 'epic' %}
                                    ุฃุณุทูุฑู
                                {% elif listings.rarity.lower() == 'legendary' %}
                                    ุฎุงุฑู
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                
                </div>
        
                <!-- Packages Section -->
                <div class="market-section">
                    <div class="section-header">
                        <h3>ุงูุจุทุงูุงุช ุงูุนุดูุงุฆูุฉ</h3>
                        <button class="action-button add_pack">ุฅูุดุงุก ุจุงูุฌ ุฌุฏูุฏ</button>
                    </div>
                
                    {% for pack in packs %}
                        <div class="player-card">
                            <div class="player-avatar">
                                <img src="{{ pack.image_url }}" alt="{{ pack.name }}" style="width: 50px; height: 50px;">
                            </div>
                            <div class="player-info">
                                <div class="player-name">{{ pack.name }}</div>
                                <div class="player-stats">{{ pack.player_count }} ูุงุนุจูู | ุถูุงู ูุงุนุจ ูุงุฏุฑ</div>
                            </div>
                            <div class="player-price">${{ pack.price }}</div>
                            <button class="action-button delete_pack" data-pack-id="{{ pack.id }}">ุญุฐู ุงูุจุงูุฌ</button> <!-- ุฒุฑ ุงูุญุฐู -->
                        </div>
                    {% endfor %}
                </div>
                
                
            </div>
        


        <!-- ุฅุถุงูุฉ ุจุงูุฌ ุฌุฏูุฏู -->

        <div class="modal-overlay" id="packModalOverlay"></div>
        <div class="slide-modal" id="packModal">
            <div class="modal-header">
                <h3 class="modal-title">ุฅุถุงูุฉ ุจุงูุฌ ุฌุฏูุฏ</h3>
                <button class="close-modal" id="closePackModal">ร</button>
            </div>
            
            <div class="modal-body">
                <form id="newPackForm">
                    <div class="form-group">
                        <label class="form-label">ุงุณู ุงูุจุงูุฌ</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ุงููุตู</label>
                        <textarea class="form-input" name="description" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ุงูุณุนุฑ</label>
                        <input type="number" class="form-input" name="price" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ุนุฏุฏ ุงููุงุนุจูู</label>
                        <input type="number" class="form-input" name="player_count" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ูุณุจ ุงููุงุฏุฑูุฉ</label>
                        <div class="rarity-grid">
                            <div class="rarity-input">
                                <label>ุนุงุฏู</label>
                                <input type="number" class="form-input" name="rarity_common" value="70">
                            </div>
                            <div class="rarity-input">
                                <label>ูุงุฏุฑ</label>
                                <input type="number" class="form-input" name="rarity_rare" value="20">
                            </div>
                            <div class="rarity-input">
                                <label>ุฃุณุทูุฑู</label>
                                <input type="number" class="form-input" name="rarity_epic" value="8">
                            </div>
                            <div class="rarity-input">
                                <label>ุฎุงุฑู</label>
                                <input type="number" class="form-input" name="rarity_legendary" value="2">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group image-upload" onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" accept="image/*" style="display: none">
                        <svg class="upload-icon" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <div class="upload-text">ุงุถุบุท ูุฅุถุงูุฉ ุตูุฑุฉ ุงูุจุงูุฌ</div>
                        <div class="upload-subtext">PNG, JPG ุญุชู 5 ููุฌุงุจุงูุช</div>
                    </div>
                    
                    <div class="preview-container" style="display: none;">
                        <img class="preview-image" src="" alt="ูุนุงููุฉ ุงูุตูุฑุฉ">
                        <button type="button" class="remove-image">ร</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="is_active" checked>
                            ุชูุนูู ุงูุจุงูุฌ
                        </label>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button class="action-button" id="cancelPackBtn">ุฅูุบุงุก</button>
                <button class="action-button" id="savePackBtn" style="background: linear-gradient(45deg, #00ff00, #44ff44);">ุญูุธ</button>
            </div>
        </div>

        <!-- ุฅุถุงูุฉ ูุงุนุจ ููุณูู -->

        <div class="modal-overlay" id="listingModalOverlay"></div>
        <div class="slide-modal" id="listingModal">
            <div class="modal-header">
                <h3 class="modal-title">ุฅุถุงูุฉ ูุงุนุจ ููุณูู</h3>
                <button type="button" class="close-modal" id="closeListingModal" aria-label="ุฅุบูุงู">ร</button>
            </div>
            
            <div class="modal-body">
                
                <form method="POST" id="newListingForm">
                    {{ formmarket.hidden_tag() }}
                    
                    <!-- CSRF Token -->
                    <meta name="csrf-token" content="{{ csrf_token }}">
                    
                    <div class="form-group">
                        <label class="form-label" for="playerSelect">{{ formmarket.player_id.label }}</label>
                        {{ formmarket.player_id(class="form-input", id="playerSelect", required=True) }}
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="price">{{ formmarket.price.label }}</label>
                        {{ formmarket.price(class="form-input", type="number", min="1", required=True) }}
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="expires_at">{{ formmarket.expires_at.label }}</label>
                        {{ formmarket.expires_at(class="form-input", type="datetime-local", required=True) }}
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="status">{{ formmarket.status.label }}</label>
                        {{ formmarket.status(class="form-input", required=True) }}
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="action-button" id="cancelListingBtn">ุฅูุบุงุก</button>
                        <button type="submit" class="action-button primary-button" id="saveListingBtn">
                            ุญูุธ
                        </button>
                    </div>
                </form>
            </div>
        </div>



                <!-- ูุณู ุงูุฑุณูู ุงูุจูุงููุฉ -->
                <div class="chart-section">
                    <h3>ุชุญููู ุงูุจูุงูุงุช ูุงูุฑุณูู ุงูุจูุงููุฉ</h3>
                    <div class="chart-container">
                        <canvas id="playerStatsChart"></canvas>
                    </div>
                </div>
            </main>
            
            <script>
                // ุฅุนุฏุงุฏ ุงูุฑุณู ุงูุจูุงูู ุจุงุณุชุฎุฏุงู ููุชุจุฉ Chart.js
                const ctx = document.getElementById('playerStatsChart').getContext('2d');
                const playerStatsChart = new Chart(ctx, {
                    type: 'bar', // ููุน ุงูุฑุณู ุงูุจูุงูู
                    data: {
                        labels: ['ุงููุงุนุจูู', 'ุนูููุงุช ุงูุจูุน', 'ุงูุจุทุงูุงุช ุงููุงุฏุฑุฉ', 'ุงููุณุชุฎุฏููู ุงููุดุทูู'], // ุชุณููุงุช ุงูุจูุงูุงุช
                        datasets: [{
                            label: 'ุงูุฅุญุตุงุฆูุงุช',
                            data: [1234, 845, 156, 2567], // ุงูููู ุงูุชู ุณูุชู ุนุฑุถูุง ูู ุงูุฑุณู ุงูุจูุงูู
                            backgroundColor: 'rgba(255,0,0,0.3)',
                            borderColor: 'rgba(255,0,0,1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

            
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async function(e) {
                            e.preventDefault();  // ููุน ุงููุนู ุงูุงูุชุฑุงุถู ููุฒุฑ
                            
                            const playerId = this.getAttribute('data-id');
                            
                            if (!playerId) {
                                showNotification("ุฎุทุฃ: ูุนุฑู ุงููุงุนุจ ุบูุฑ ููุฌูุฏ", "error");
                                return;
                            }
                            
                            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุงุนุจุ')) {
                                try {
                                    const playerCard = this.closest('.player-card');
                                    if (!playerCard) {
                                        showNotification("ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุจุทุงูุฉ ุงููุงุนุจ", "error");
                                        return;
                                    }
                                    
                                    // ุงูุญุตูู ุนูู CSRF token ูู ุนูุงูุฉ meta
                                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                                    
                                    playerCard.classList.add('deleting');
                                    this.disabled = true;
                                    
                                    const response = await fetch(`/delete-player-market/${playerId}`, {
                                        method: 'DELETE',
                                        headers: {
                                            'Accept': 'application/json',
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': csrfToken  // ุฅุถุงูุฉ CSRF token ููุทูุจ
                                        }
                                    });
                                    
                                    console.log("Response status:", response.status);
                                    const responseText = await response.text();
                                    console.log("Response text:", responseText);
                                    
                                    let data;
                                    try {
                                        data = JSON.parse(responseText);
                                    } catch (e) {
                                        throw new Error('ุงุณุชุฌุงุจุฉ ุบูุฑ ุตุงูุญุฉ ูู ุงูุฎุงุฏู: ' + responseText);
                                    }
                                    
                                    if (response.ok) {
                                        setTimeout(() => {
                                            playerCard.remove();
                                            showNotification("ุชู ุงูุญุฐู ุจูุฌุงุญ!", "success");
                                        }, 500);
                                    } else {
                                        playerCard.classList.remove('deleting');
                                        this.disabled = false;
                                        showNotification(data.message || "ูุดู ุงูุญุฐู", "error");
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    this.disabled = false;
                                    showNotification("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู: " + error.message, "error");
                                }
                            }
                        });
                    });
                });
                
                // ุฏุงูุฉ ูุนุฑุถ ุงูุฅุดุนุงุฑุงุช ูููุณุชุฎุฏู
                function showNotification(message, type) {
                    const notification = document.createElement('div');
                    notification.textContent = message;
                    notification.className = `notification ${type}`;
                    notification.style.position = 'fixed';
                    notification.style.top = '20px';
                    notification.style.right = '20px';
                    notification.style.padding = '15px';
                    notification.style.borderRadius = '5px';
                    notification.style.zIndex = '1000';
                    notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                    notification.style.color = 'white';
                    
                    // ุฅุถุงูุฉ ุงูุฅุดุนุงุฑ ุฅูู ุงูุตูุญุฉ
                    document.body.appendChild(notification);
                    
                    // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุจุนุฏ 3 ุซูุงูู
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            </script>
            

            <script src="static/js/dashboard.js"></script>
    </body>
</html>